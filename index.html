<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Energy Kashiwa - Feedback & Review</title>
  <style>
    :root{
      --bg1:#0f1923; --bg2:#1a2a3a;
      --card: rgba(255,255,255,.05);
      --line: rgba(255,255,255,.10);
      --muted:#93a4b5;
      --text:#e8e8e8;
      --accent1:#ff6b35;
      --accent2:#f7c948;
      --ok:#2ecc71;
      --warn:#ff6b6b;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    }
    body{
      margin:0; color:var(--text);
      background: linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg1));
      min-height:100vh;
    }
    .wrap{ max-width:520px; margin:0 auto; padding:24px 16px 40px; position:relative; }
    .brand{
      text-align:center; margin:8px 0 20px;
    }
    .brand .t{
      font-weight:900; font-size:26px; letter-spacing:-.5px;
      background: linear-gradient(135deg,var(--accent1),var(--accent2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .brand .s{ color:var(--muted); font-size:12px; letter-spacing:.18em; margin-top:6px;}
    .bar{ display:flex; gap:8px; padding:0 16px; margin:16px 0 18px; }
    .bar i{ flex:1; height:3px; border-radius:2px; background: rgba(255,255,255,.10); }
    .bar i.on{ background: linear-gradient(90deg,var(--accent1),var(--accent2)); }
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:18px;
      box-shadow: 0 10px 24px rgba(0,0,0,.20);
    }
    h2{ margin:0 0 6px; font-size:18px; }
    p{ margin:0 0 14px; color:var(--muted); font-size:13px; line-height:1.7; }
    .stars{ display:flex; gap:10px; justify-content:center; padding:12px 0 6px; }
    .starbtn{
      width:44px; height:44px; border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:#fff; font-size:18px; font-weight:800;
      cursor:pointer;
      transition:.15s transform ease, .15s background ease, .15s border-color ease;
    }
    .starbtn:hover{ transform: translateY(-1px); }
    .starbtn.on{
      border-color: rgba(255,107,53,.60);
      background: rgba(255,107,53,.12);
    }
    .grid{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .chip{
      display:flex; align-items:center; gap:10px;
      padding:12px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
    }
    .chip.on{
      border-color: rgba(255,107,53,.55);
      background: linear-gradient(135deg, rgba(255,107,53,.16), rgba(247,201,72,.08));
    }
    .chip .e{ width:26px; text-align:center; font-size:18px; }
    .chip .l{ font-size:14px; }
    textarea, input{
      width:100%;
      box-sizing:border-box;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    textarea{ min-height:88px; resize:vertical; }
    textarea::placeholder, input::placeholder{ color: rgba(147,164,181,.65); }

    .row{ display:flex; gap:10px; margin-top:14px; }
    .btn{
      width:100%;
      padding:14px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: #c9d5e1;
      font-weight:800;
      cursor:pointer;
    }
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, var(--accent1), #e85d2a);
      color:white;
    }
    .btn.ok{
      border:none;
      background: linear-gradient(135deg, var(--ok), #27ae60);
      color:white;
    }
    .btn:disabled{ opacity:.45; cursor:default; }
    .note{
      margin-top:12px;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(247,201,72,.18);
      background: rgba(247,201,72,.06);
      color:#d6bf74;
      font-size:12px; line-height:1.7;
    }
    .err{
      margin-top:12px;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,107,107,.18);
      background: rgba(255,107,107,.08);
      color:#ffb3b3;
      font-size:12px; line-height:1.7;
    }
    .reviewbox{
      margin-top:12px;
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      white-space:pre-wrap;
      line-height:1.8;
      font-size:14px;
    }
    .small{ font-size:12px; color: var(--muted); margin-top:10px; line-height:1.6; }
    a.linkbtn{
      display:block; text-decoration:none; text-align:center;
      padding:14px 12px;
      border-radius:12px;
      color:#fff;
      background: linear-gradient(135deg, #4285f4, #3367d6);
      font-weight:900;
      margin-top:10px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="t">Energy Climbing Gym</div>
      <div class="s">FEEDBACK & REVIEW</div>
    </div>

    <div class="bar" aria-hidden="true">
      <i id="b1" class="on"></i><i id="b2"></i><i id="b3"></i>
    </div>

    <div id="app" class="card"></div>
  </div>

<script>
  // â˜… ã“ã“ã ã‘å·®ã—æ›¿ãˆï¼ˆPlace IDã‚’å…¥ã‚Œã‚‹ï¼‰
  const GOOGLE_REVIEW_URL = "https://search.google.com/local/writereview?placeid=ChIJMRs7cu-cGGARjXtiWvPWKZw";

  const GOOD_POINTS = [
    { id:"clean", label:"æ–½è¨­ãŒãã‚Œã„ãƒ»æ¸…æ½”", emoji:"âœ¨" },
    { id:"routes", label:"å£ãƒ»èª²é¡Œã®ç¨®é¡ãŒè±Šå¯Œ", emoji:"ğŸ§—" },
    { id:"staff", label:"ã‚¹ã‚¿ãƒƒãƒ•ãŒè¦ªåˆ‡ãƒ»ä¸å¯§", emoji:"ğŸ˜Š" },
    { id:"beginner", label:"åˆå¿ƒè€…ã«ã‚„ã•ã—ã„", emoji:"ğŸ”°" },
    { id:"setting", label:"èª²é¡Œã®ã‚»ãƒƒãƒˆãŒé¢ç™½ã„", emoji:"ğŸ¯" },
    { id:"price", label:"æ–™é‡‘ãŒãƒªãƒ¼ã‚ºãƒŠãƒ–ãƒ«", emoji:"ğŸ’°" },
    { id:"access", label:"ã‚¢ã‚¯ã‚»ã‚¹ãŒè‰¯ã„", emoji:"ğŸšƒ" },
    { id:"atmosphere", label:"é›°å›²æ°—ãƒ»å±…å¿ƒåœ°ãŒè‰¯ã„", emoji:"â˜•" },
    { id:"kids", label:"ã‚­ãƒƒã‚ºã«ã‚‚å¯¾å¿œã—ã¦ã„ã‚‹", emoji:"ğŸ‘§" },
    { id:"training", label:"ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨­å‚™ãŒå……å®Ÿ", emoji:"ğŸ’ª" },
  ];

  const VISIT_TYPE = [
    { id:"first", label:"åˆã‚ã¦" },
    { id:"few", label:"æ•°å›ç›®" },
    { id:"regular", label:"å¸¸é€£" },
  ];

  const COMPANION = [
    { id:"solo", label:"ã²ã¨ã‚Šã§" },
    { id:"friends", label:"å‹äººã¨" },
    { id:"family", label:"å®¶æ—ãƒ»å­ã©ã‚‚ã¨" },
    { id:"couple", label:"ã‚«ãƒƒãƒ—ãƒ«ã§" },
  ];

  const state = {
    step: 1,
    rating: 0,
    good: new Set(),
    visitType: "",
    companion: "",
    freeComment: "",
    improve: "",
    improveComment: "",
    generated: "",
    loading: false,
    error: ""
  };

  function setBar(){
    document.getElementById("b1").classList.toggle("on", state.step >= 1);
    document.getElementById("b2").classList.toggle("on", state.step >= 2);
    document.getElementById("b3").classList.toggle("on", state.step >= 3);
  }

  function htmlesc(s){
    return (s||"").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  }

  function render(){
    setBar();
    const app = document.getElementById("app");

    if(state.step === 1){
      app.innerHTML = `
        <h2>Step 1ï¼šæº€è¶³åº¦ã‚’æ•™ãˆã¦ãã ã•ã„</h2>
        <p>é‹å–¶æ”¹å–„ã«ä½¿ã„ã¾ã™ã€‚Googleãƒãƒƒãƒ—ã¸ã®æŠ•ç¨¿ã¯ä»»æ„ã§ã™ã€‚</p>
        <div class="stars">
          ${[1,2,3,4,5].map(n => `
            <button class="starbtn ${state.rating===n?'on':''}" data-star="${n}">â˜…${n}</button>
          `).join("")}
        </div>
        <div class="row">
          <button class="btn primary" id="toStep2" ${state.rating? "" : "disabled"}>æ¬¡ã¸ â†’</button>
        </div>
        <div class="small">â€»ã“ã®ç”»é¢ã§ã¯æŠ•ç¨¿ã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã€‚æº€è¶³åº¦ã®è¨˜éŒ²ã ã‘ã§ã™ã€‚</div>
      `;

      app.querySelectorAll("[data-star]").forEach(b=>{
        b.addEventListener("click", ()=>{ state.rating = Number(b.dataset.star); render(); });
      });
      document.getElementById("toStep2").addEventListener("click", ()=>{
        state.step = 2; state.error=""; render();
      });
      return;
    }

    if(state.step === 2){
      const high = state.rating >= 4;

      if(high){
        app.innerHTML = `
          <h2>Step 2ï¼šè‰¯ã‹ã£ãŸç‚¹ã‚’æ•™ãˆã¦ãã ã•ã„</h2>
          <p>ã‚ã¦ã¯ã¾ã‚‹ã‚‚ã®ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆè¤‡æ•°å¯ï¼‰ã€‚ä»»æ„é …ç›®ã¯ç©ºã§ã‚‚OKã§ã™ã€‚</p>

          <div class="grid">
            ${GOOD_POINTS.map(p => `
              <div class="chip ${state.good.has(p.id)?'on':''}" data-good="${p.id}">
                <div class="e">${state.good.has(p.id) ? "âœ…" : p.emoji}</div>
                <div class="l">${htmlesc(p.label)}</div>
              </div>
            `).join("")}
          </div>

          <div style="margin-top:14px;">
            <p style="margin:0 0 8px;">æ¥åº—å›æ•°ï¼ˆä»»æ„ï¼‰</p>
            <div class="row">
              ${VISIT_TYPE.map(v => `
                <button class="btn ${state.visitType===v.id?'primary':''}" data-visit="${v.id}">${htmlesc(v.label)}</button>
              `).join("")}
            </div>
          </div>

          <div style="margin-top:12px;">
            <p style="margin:0 0 8px;">èª°ã¨æ¥ã¾ã—ãŸã‹ï¼Ÿï¼ˆä»»æ„ï¼‰</p>
            <div class="row" style="flex-wrap:wrap;">
              ${COMPANION.map(c => `
                <button class="btn ${state.companion===c.id?'primary':''}" style="flex:1 0 46%;" data-comp="${c.id}">${htmlesc(c.label)}</button>
              `).join("")}
            </div>
          </div>

          <div style="margin-top:12px;">
            <p style="margin:0 0 8px;">ã²ã¨ã“ã¨ï¼ˆä»»æ„ï¼‰</p>
            <textarea id="freeComment" placeholder="ä¾‹ï¼š3ç´šã®èª²é¡ŒãŒæ¥½ã—ã‹ã£ãŸã€åˆã‚ã¦ã§ã‚‚å®‰å¿ƒã ã£ãŸâ€¦">${htmlesc(state.freeComment)}</textarea>
          </div>

          <div class="row">
            <button class="btn" id="back">â† æˆ»ã‚‹</button>
            <button class="btn primary" id="gen" ${state.loading ? "disabled" : ""}>${state.loading ? "ä½œæˆä¸­â€¦" : "ä¸‹æ›¸ãã‚’ä½œã‚‹ âœï¸"}</button>
          </div>

          ${state.error ? `<div class="err">${htmlesc(state.error)}</div>` : ""}

          <div class="note">
            ğŸ’¡ ç”Ÿæˆæ–‡ã¯ãã®ã¾ã¾ã§ã‚‚ã€æ›¸ãæ›ãˆã¦ã‚‚OKã§ã™ã€‚å®Ÿæ„Ÿã«åˆã‚ãªã„éƒ¨åˆ†ã¯å‰Šé™¤ãƒ»ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
          </div>

          <a class="linkbtn" href="${GOOGLE_REVIEW_URL}" target="_blank" rel="noopener">Googleãƒãƒƒãƒ—ã§æŠ•ç¨¿ã™ã‚‹ï¼ˆä»»æ„ï¼‰â†’</a>
          <div class="small">â€»ãƒªãƒ³ã‚¯ã¯ã„ã¤ã§ã‚‚ä½¿ãˆã¾ã™ã€‚æŠ•ç¨¿ã™ã‚‹ï¼ã—ãªã„ã¯è‡ªç”±ã§ã™ã€‚</div>
        `;

        app.querySelectorAll("[data-good]").forEach(el=>{
          el.addEventListener("click", ()=>{
            const id = el.dataset.good;
            state.good.has(id) ? state.good.delete(id) : state.good.add(id);
            render();
          });
        });
        app.querySelectorAll("[data-visit]").forEach(el=>{
          el.addEventListener("click", ()=>{
            const id = el.dataset.visit;
            state.visitType = (state.visitType === id) ? "" : id;
            render();
          });
        });
        app.querySelectorAll("[data-comp]").forEach(el=>{
          el.addEventListener("click", ()=>{
            const id = el.dataset.comp;
            state.companion = (state.companion === id) ? "" : id;
            render();
          });
        });

        document.getElementById("freeComment").addEventListener("input", (e)=> state.freeComment = e.target.value);

        document.getElementById("back").addEventListener("click", ()=>{
          state.step = 1; state.error=""; render();
        });

        document.getElementById("gen").addEventListener("click", async ()=>{
          state.loading = true; state.error=""; render();
          try{
            const payload = {
              rating: state.rating,
              goodPoints: Array.from(state.good),
              visitType: state.visitType,
              companion: state.companion,
              freeComment: state.freeComment
            };
            const res = await fetch("/api/generate", {
              method:"POST",
              headers: { "Content-Type":"application/json" },
              body: JSON.stringify(payload)
            });
            const data = await res.json().catch(()=> ({}));
            if(!res.ok) throw new Error(data?.error || ("HTTP " + res.status));
            state.generated = data.review || "";
            state.step = 3;
          }catch(err){
            state.error = "ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚(" + (err?.message || "unknown") + ")";
          }finally{
            state.loading = false;
            render();
          }
        });

        return;
      }

      // â˜…1-3
      app.innerHTML = `
        <h2>Step 2ï¼šæ”¹å–„ã—ã¦ã»ã—ã„ç‚¹ï¼ˆä»»æ„ï¼‰</h2>
        <p>ã„ãŸã ã„ãŸå†…å®¹ã¯é‹å–¶æ”¹å–„ã«æ´»ã‹ã—ã¾ã™ã€‚æ›¸ã‘ã‚‹ç¯„å›²ã§å¤§ä¸ˆå¤«ã§ã™ã€‚</p>

        <p style="margin:0 0 8px;">ã©ã“ãŒæ°—ã«ãªã‚Šã¾ã—ãŸã‹ï¼Ÿï¼ˆä»»æ„ï¼‰</p>
        <input id="improve" placeholder="ä¾‹ï¼šæ··ã¿å…·åˆã€èª¬æ˜ã®åˆ†ã‹ã‚Šã‚„ã™ã•ã€æ¸©åº¦æ„Ÿã€èª²é¡Œã®å‚¾å‘â€¦"
          value="${htmlesc(state.improve)}"/>

        <div style="margin-top:12px;">
          <p style="margin:0 0 8px;">è‡ªç”±è¨˜è¿°ï¼ˆä»»æ„ï¼‰</p>
          <textarea id="improveComment" placeholder="ä¾‹ï¼šã‚‚ã†å°‘ã—ã“ã†ã ã£ãŸã‚‰å¬‰ã—ã„ã€ãªã©">${htmlesc(state.improveComment)}</textarea>
        </div>

        <div class="row">
          <button class="btn" id="back">â† æˆ»ã‚‹</button>
          <button class="btn primary" id="send" ${state.loading ? "disabled" : ""}>${state.loading ? "é€ä¿¡ä¸­â€¦" : "é€ä¿¡ã™ã‚‹"}</button>
        </div>

        ${state.error ? `<div class="err">${htmlesc(state.error)}</div>` : ""}

        <a class="linkbtn" href="${GOOGLE_REVIEW_URL}" target="_blank" rel="noopener">Googleãƒãƒƒãƒ—ã§æŠ•ç¨¿ã™ã‚‹ï¼ˆä»»æ„ï¼‰â†’</a>
        <div class="small">â€»æŠ•ç¨¿ã¯ä»»æ„ã§ã™ã€‚å†…å®¹ã¯ã”è‡ªèº«ã®è¨€è‘‰ã§è‡ªç”±ã«ç·¨é›†ã—ã¦ãã ã•ã„ã€‚</div>
      `;

      document.getElementById("improve").addEventListener("input", (e)=> state.improve = e.target.value);
      document.getElementById("improveComment").addEventListener("input", (e)=> state.improveComment = e.target.value);

      document.getElementById("back").addEventListener("click", ()=>{
        state.step = 1; state.error=""; render();
      });

      document.getElementById("send").addEventListener("click", async ()=>{
        state.loading = true; state.error=""; render();
        try{
          const payload = {
            rating: state.rating,
            improve: state.improve,
            comment: state.improveComment
          };
          const res = await fetch("/api/feedback", {
            method:"POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
          const data = await res.json().catch(()=> ({}));
          if(!res.ok) throw new Error(data?.error || ("HTTP " + res.status));
          state.generated = "ã”æ„è¦‹ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚é‹å–¶æ”¹å–„ã«æ´»ã‹ã—ã¾ã™ã€‚";
          state.step = 3;
        }catch(err){
          state.error = "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚(" + (err?.message || "unknown") + ")";
        }finally{
          state.loading = false;
          render();
        }
      });

      return;
    }

    // step 3 result
    app.innerHTML = `
      <h2>å®Œäº†ã—ã¾ã—ãŸ</h2>
      <p>å†…å®¹ã‚’ç¢ºèªã—ã¦ã€å¿…è¦ãªã‚‰ç·¨é›†ã—ã¦ãã ã•ã„ã€‚</p>

      <div class="reviewbox">${htmlesc(state.generated || "")}</div>

      ${state.rating >= 4 ? `
        <div class="row">
          <button class="btn ok" id="copy">ã‚³ãƒ”ãƒ¼ã™ã‚‹ ğŸ“‹</button>
          <button class="btn" id="again">åˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ ğŸ”„</button>
        </div>
      ` : `
        <div class="row">
          <button class="btn" id="reset">æœ€åˆã«æˆ»ã‚‹</button>
        </div>
      `}

      <a class="linkbtn" href="${GOOGLE_REVIEW_URL}" target="_blank" rel="noopener">Googleãƒãƒƒãƒ—ã§æŠ•ç¨¿ã™ã‚‹ï¼ˆä»»æ„ï¼‰â†’</a>

      <div class="note">
        ğŸ’¡ æŠ•ç¨¿å‰ã«è‡ªç”±ã«æ›¸ãæ›ãˆã¦OKã§ã™ã€‚å®Ÿéš›ã®æ„Ÿæƒ³ã«åˆã‚ãªã„éƒ¨åˆ†ã¯ä¿®æ­£ãƒ»å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
      </div>
    `;

    if(state.rating >= 4){
      document.getElementById("copy").addEventListener("click", async ()=>{
        try{
          await navigator.clipboard.writeText(state.generated || "");
          document.getElementById("copy").textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ âœ“";
          setTimeout(()=> document.getElementById("copy").textContent = "ã‚³ãƒ”ãƒ¼ã™ã‚‹ ğŸ“‹", 1600);
        }catch{
          alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
        }
      });

      document.getElementById("again").addEventListener("click", async ()=>{
        // step2ã®ã¾ã¾å†ç”Ÿæˆ
        state.step = 2;
        render();
        document.getElementById("gen")?.click();
      });
    }else{
      document.getElementById("reset").addEventListener("click", ()=>{
        Object.assign(state,{
          step:1, rating:0, good:new Set(), visitType:"", companion:"",
          freeComment:"", improve:"", improveComment:"", generated:"",
          loading:false, error:""
        });
        render();
      });
    }
  }

  render();
</script>
</body>
</html>
